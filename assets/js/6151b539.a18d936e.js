"use strict";(self.webpackChunkdoc_website=self.webpackChunkdoc_website||[]).push([[8389],{9349:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>i,contentTitle:()=>l,default:()=>h,frontMatter:()=>o,metadata:()=>c,toc:()=>a});var r=s(4848),t=s(8453);const o={},l="Koa \u6d0b\u8471\u6a21\u578b\u539f\u7406\u5206\u6790",c={id:"others/node/koa-compose-modal",title:"Koa \u6d0b\u8471\u6a21\u578b\u539f\u7406\u5206\u6790",description:"Koa \u6709\u4e24\u4e2a\u6838\u5fc3\u77e5\u8bc6\u70b9\uff1a\u4e00\u4e2a\u662f\u4e2d\u95f4\u4ef6ctx\uff0c\u4e00\u4e2a\u5c31\u662f\u6d0b\u8471\u6a21\u578b\u3002",source:"@site/docs/others/node/koa-compose-modal.md",sourceDirName:"others/node",slug:"/others/node/koa-compose-modal",permalink:"/docs/others/node/koa-compose-modal",draft:!1,unlisted:!1,tags:[],version:"current",frontMatter:{},sidebar:"othersSidebar",previous:{title:"Array API\u4e0eV8\u6e90\u7801\u89e3\u6790",permalink:"/docs/others/js/v8-array-method"},next:{title:"Nginx\u53cd\u5411\u4ee3\u7406",permalink:"/docs/others/node/nginx"}},i={},a=[{value:"1. \u8ba4\u8bc6\u6d0b\u8471\u6a21\u578b",id:"1-\u8ba4\u8bc6\u6d0b\u8471\u6a21\u578b",level:2},{value:"2. \u539f\u7406",id:"2-\u539f\u7406",level:2},{value:"2.1 \u4e2d\u95f4\u4ef6\u7ba1\u7406",id:"21-\u4e2d\u95f4\u4ef6\u7ba1\u7406",level:3},{value:"2.2 next\u5b9e\u73b0",id:"22-next\u5b9e\u73b0",level:3},{value:"3. \u601d\u8003",id:"3-\u601d\u8003",level:2},{value:"\u53c2\u8003",id:"\u53c2\u8003",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.h1,{id:"koa-\u6d0b\u8471\u6a21\u578b\u539f\u7406\u5206\u6790",children:"Koa \u6d0b\u8471\u6a21\u578b\u539f\u7406\u5206\u6790"}),"\n",(0,r.jsx)(n.p,{children:"Koa \u6709\u4e24\u4e2a\u6838\u5fc3\u77e5\u8bc6\u70b9\uff1a\u4e00\u4e2a\u662f\u4e2d\u95f4\u4ef6ctx\uff0c\u4e00\u4e2a\u5c31\u662f\u6d0b\u8471\u6a21\u578b\u3002"}),"\n",(0,r.jsxs)(n.p,{children:["\u4e2d\u95f4\u4ef6ctx\u5229\u7528js\u539f\u578b\uff0c\u5f88\u5de7\u5999\u7684\u628arequest\u548cresponse\u5bf9\u8c61\u5c01\u88c5\u5728\u91cc\u9762\u3002\u8be6\u7ec6\u7684\u5b9e\u73b0\u53ef\u770b\u7b14\u8005\u5b9e\u73b0\u7684\u7b80\u7248koa ",(0,r.jsx)(n.a,{href:"https://github.com/lq782655835/build-your-own-koa",children:"build-your-own-koa"}),"\u3002"]}),"\n",(0,r.jsx)(n.p,{children:"\u53e6\u5916\u4e00\u4e2a\u6838\u5fc3\u5c31\u662f\u672c\u6587\u8981\u5206\u6790\u7684\u6d0b\u8471\u6a21\u578b\u3002"}),"\n",(0,r.jsx)(n.h2,{id:"1-\u8ba4\u8bc6\u6d0b\u8471\u6a21\u578b",children:"1. \u8ba4\u8bc6\u6d0b\u8471\u6a21\u578b"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"const Koa = require('koa');\n\nconst app = new Koa();\nconst PORT = 3000;\n\n// #1\napp.use(async (ctx, next)=>{\n    console.log(1)\n    await next();\n    console.log(1)\n});\n// #2\napp.use(async (ctx, next) => {\n    console.log(2)\n    await next();\n    console.log(2)\n})\n\napp.use(async (ctx, next) => {\n    console.log(3)\n})\n\napp.listen(PORT);\nconsole.log(`http://localhost:${PORT}`);\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u6253\u5370\u987a\u5e8f\uff1a"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{children:"1\n2\n3\n2\n1\n"})}),"\n",(0,r.jsxs)(n.p,{children:["\u5f53\u7a0b\u5e8f\u8fd0\u884c\u5230await next()\u7684\u65f6\u5019\u5c31\u4f1a\u6682\u505c\u5f53\u524d\u7a0b\u5e8f\uff0c\u8fdb\u5165\u4e0b\u4e00\u4e2a\u4e2d\u95f4\u4ef6\uff0c",(0,r.jsx)(n.strong,{children:"\u5904\u7406\u5b8c\u4e4b\u540e\u624d\u4f1a\u56de\u8fc7\u5934\u6765\u7ee7\u7eed\u5904\u7406"}),"\u3002"]}),"\n",(0,r.jsx)(n.h2,{id:"2-\u539f\u7406",children:"2. \u539f\u7406"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.code,{children:"\u6838\u5fc3\uff1a\u4e2d\u95f4\u4ef6\u7ba1\u7406\u548cnext\u5b9e\u73b0"}),"\uff0c\u5176\u4e2dnext\u662f\u5de7\u5999\u7684\u4f7f\u7528\u4e86Promise\u7279\u6027\u3002\u6d0b\u8471\u6a21\u578b\uff0c\u672c\u8d28\u4e0a\u662fPromise.resolve()\u7684\u9012\u5f52\u3002"]}),"\n",(0,r.jsx)(n.h3,{id:"21-\u4e2d\u95f4\u4ef6\u7ba1\u7406",children:"2.1 \u4e2d\u95f4\u4ef6\u7ba1\u7406"}),"\n",(0,r.jsx)(n.p,{children:"app.listen\u4f7f\u7528\u4e86this.callback()\u6765\u751f\u6210node\u7684httpServer\u7684\u56de\u8c03\u51fd\u6570\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"listen(...args) {\n    debug('listen');\n    const server = http.createServer(this.callback());\n    return server.listen(...args);\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"Koa.js\u4e2d\u95f4\u4ef6\u5f15\u64ce\u662f\u6709koa-compose\u6a21\u5757\uff0c\u5373\u5982\u4e0b\u7684compose\u65b9\u6cd5"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"callback() {\n    const fn = compose(this.middleware); // \u6838\u5fc3\uff1a\u4e2d\u95f4\u4ef6\u7684\u7ba1\u7406\u548cnext\u7684\u5b9e\u73b0\n    \n    if (!this.listeners('error').length) this.on('error', this.onerror);\n    \n    const handleRequest = (req, res) => {\n      const ctx = this.createContext(req, res); // \u521b\u5efactx\n      return this.handleRequest(ctx, fn);\n    };\n    \n    return handleRequest;\n}\n"})}),"\n",(0,r.jsx)(n.p,{children:"\u5f53\u6211\u4eecapp.use\u7684\u65f6\u5019\uff0c\u53ea\u662f\u628a\u65b9\u6cd5\u5b58\u5728\u4e86\u4e00\u4e2a\u6570\u7ec4\u91cc"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"use(fn) {\n    this.middleware.push(fn);\n    return this;\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"22-next\u5b9e\u73b0",children:"2.2 next\u5b9e\u73b0"}),"\n",(0,r.jsx)(n.p,{children:"dispatch\u51fd\u6570\uff0c\u5b83\u5c06\u904d\u5386\u6574\u4e2amiddleware\uff0c\u7136\u540e\u5c06context\u548cdispatch(i + 1)\u4f20\u7ed9middleware\u4e2d\u7684\u65b9\u6cd5\u3002"}),"\n",(0,r.jsx)(n.p,{children:"dispatch return Promise\u8fd9\u6bb5\u4ee3\u7801\u5c31\u5f88\u5de7\u5999\u7684\u5b9e\u73b0\u4e86\u4e24\u70b9:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:["\u5c06",(0,r.jsx)(n.code,{children:"context"}),"\u4e00\u8def\u4f20\u4e0b\u53bb\u7ed9\u4e2d\u95f4\u4ef6"]}),"\n",(0,r.jsxs)(n.li,{children:["\u5c06",(0,r.jsx)(n.code,{children:"middleware"}),"\u4e2d\u7684\u4e0b\u4e00\u4e2a\u4e2d\u95f4\u4ef6",(0,r.jsx)(n.code,{children:"fn"}),"\u4f5c\u4e3a\u672a\u6765",(0,r.jsx)(n.code,{children:"next"}),"\u7684\u8fd4\u56de\u503c"]}),"\n"]}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"function compose (middleware) {\n  return function (context, next) {\n    // last called middleware #\n    let index = -1\n    return dispatch(0)\n    \n    function dispatch (i) {\n      if (i <= index) return Promise.reject(new Error('next() called multiple times'))\n      index = i\n      let fn = middleware[i]\n      if (i === middleware.length) fn = next\n      if (!fn) return Promise.resolve()\n      try {\n          // \u6838\u5fc3\u4ee3\u7801\uff1a\u8fd4\u56dePromise\n          // next\u65f6\uff0c\u4ea4\u7ed9\u4e0b\u4e00\u4e2adispatch\uff08\u4e0b\u4e00\u4e2a\u4e2d\u95f4\u4ef6\u65b9\u6cd5\uff09\n          // \u540c\u65f6\uff0c\u5f53\u524d\u540c\u6b65\u4ee3\u7801\u6302\u8d77\uff0c\u76f4\u5230\u4e2d\u95f4\u4ef6\u5168\u90e8\u5b8c\u6210\u540e\u7ee7\u7eed\n        return Promise.resolve(fn(context, function next () {\n          return dispatch(i + 1)\n        }))\n      } catch (err) {\n        return Promise.reject(err)\n      }\n    }\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h2,{id:"3-\u601d\u8003",children:"3. \u601d\u8003"}),"\n",(0,r.jsx)(n.p,{children:"\u6d0b\u8471\u6a21\u578b\u5b9e\u73b0\u539f\u7406\uff0c\u7b49\u540c\u4e8e\u5982\u4e0b\u4ee3\u7801\uff1a"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"next()\u8fd4\u56de\u7684\u662fpromise\uff0c\u9700\u8981\u4f7f\u7528await\u53bb\u7b49\u5f85promise\u7684resolve\u503c\u3002"})}),"\n",(0,r.jsx)(n.p,{children:"promise\u7684\u5d4c\u5957\u5c31\u50cf\u662f\u6d0b\u8471\u6a21\u578b\u7684\u5f62\u72b6\u5c31\u662f\u4e00\u5c42\u5305\u88f9\u7740\u4e00\u5c42\uff0c\u76f4\u5230await\u5230\u6700\u91cc\u9762\u4e00\u5c42\u7684promise\u7684resolve\u503c\u8fd4\u56de\u3002"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-js",children:"Promise.resolve(middleware1(context, async() => { // \u6ce8\u610fasync\u5173\u952e\u5b57\u4e0d\u80fd\u7701\u7565\n  return Promise.resolve(middleware2(context, async() => {\n    return Promise.resolve(middleware3(context, async() => {\n      return Promise.resolve();\n    }));\n  }));\n}))\n.then(() => {\n    console.log('end');\n});\n"})}),"\n",(0,r.jsx)(n.h2,{id:"\u53c2\u8003",children:"\u53c2\u8003"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://segmentfault.com/a/1190000013981513",children:"https://segmentfault.com/a/1190000013981513"})}),"\n",(0,r.jsx)(n.li,{children:(0,r.jsx)(n.a,{href:"https://segmentfault.com/a/1190000019897506",children:"https://segmentfault.com/a/1190000019897506"})}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>c});var r=s(6540);const t={},o=r.createContext(t);function l(e){const n=r.useContext(o);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:l(e.components),r.createElement(o.Provider,{value:n},e.children)}}}]);